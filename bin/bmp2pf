#!/usr/bin/env ruby

class BMP
  class Reader
    PIXEL_ARRAY_OFFSET = 122
    BITS_PER_PIXEL     = 24
    DIB_HEADER_SIZE    = 108

    attr_reader :pixels

    def initialize(bmp_filename)
      File.open(bmp_filename, "rb") do |file|
        read_bmp_header(file)
        read_dib_header(file)
        read_pixels(file)
      end
    end

    attr_reader :width, :height

    def read_pixels(file)
      @pixels = Array.new(@height) { Array.new(@width) }

      (@height-1).downto(0) do |y|
        0.upto(@width - 1) do |x|
          @pixels[y][x] = file.read(3).unpack("H6").first
        end
        advance_to_next_row(file)
      end
    end

    def advance_to_next_row(file)
      padding_bytes = @width % 4
      return if padding_bytes == 0

      file.pos += padding_bytes
    end

    def read_bmp_header(file)
      header = file.read(14)
      magic_number, file_size, reserved1,
      reserved2, array_location = header.unpack("A2Vv2V")

      fail "Not a bitmap file!" unless magic_number == "BM"

      unless file.size == file_size
        fail "Corrupted bitmap: File size is not as expected" 
      end

      unless array_location == PIXEL_ARRAY_OFFSET
        fail "Unsupported bitmap: pixel array does not start where expected"
      end
    end

    def read_dib_header(file)
      header = file.read(DIB_HEADER_SIZE)

      header_size, width, height, planes, bits_per_pixel,
      compression_method, image_size, hres,
      vres, n_colors, i_colors = header.unpack("Vl<2v2V2l<2V2") 

      unless header_size == DIB_HEADER_SIZE
        fail "Corrupted bitmap: DIB header does not match expected size"
      end

      unless planes == 1
        fail "Corrupted bitmap: Expected 1 plane, got #{planes}"
      end

      unless bits_per_pixel == BITS_PER_PIXEL
        fail "#{bits_per_pixel} bits per pixel bitmaps are not supported"
      end

      unless compression_method == 0
        fail "Bitmap compression not supported"
      end

      unless image_size + PIXEL_ARRAY_OFFSET == file.size
        fail "Corrupted bitmap: pixel array size isn't as expected"
      end

      @width, @height = width, height
    end
  end
end


begin
file = ARGV.first or fail "Usage bmp2pf file"
BMP::Reader.new(file).tap do |bitmap|
  unless bitmap.width == 40 && bitmap.height == 192
    fail "Bitmap must be 40px x 192px"
  end

  header = <<DASM
; Generated by bmp2pf on #{Time.now}
; DASM Assembly byte table

screen

DASM

  puts header

  puts "screen_STRIP_1"
  puts ""
  bitmap.pixels.each do |row|
    pf1 = row[0...4].reverse.map { |row| row.to_i(16) == 0xFFFFFF ? 0 : 1 }
    binary = pf1.join('') + "0000"
    puts "  .byte #{binary.to_i(2)}"
  end
  puts ""

  puts "screen_STRIP_2"
  puts ""
  bitmap.pixels.each do |row|
    pf1 = row[4...12].map { |row| row.to_i(16) == 0xFFFFFF ? 0 : 1 }
    binary = pf1.join('')
    puts "  .byte #{binary.to_i(2)}"
  end
  puts ""

  puts "screen_STRIP_3"
  puts ""
  bitmap.pixels.each do |row|
    pf1 = row[12...20].reverse.map { |row| row.to_i(16) == 0xFFFFFF ? 0 : 1 }
    binary = pf1.join('')
    puts "  .byte #{binary.to_i(2)}"
  end
  puts ""

  puts "screen_STRIP_4"
  puts ""
  bitmap.pixels.each do |row|
    pf1 = row[20...24].reverse.map { |row| row.to_i(16) == 0xFFFFFF ? 0 : 1 }
    binary = pf1.join('') + "0000"
    puts "  .byte #{binary.to_i(2)}"
  end
  puts ""

  puts "screen_STRIP_5"
  puts ""
  bitmap.pixels.each do |row|
    pf1 = row[24...32].map { |row| row.to_i(16) == 0xFFFFFF ? 0 : 1 }
    binary = pf1.join('')
    puts "  .byte #{binary.to_i(2)}"
  end
  puts ""

  puts "screen_STRIP_6"
  puts ""
  bitmap.pixels.each do |row|
    pf1 = row[32...40].reverse.map { |row| row.to_i(16) == 0xFFFFFF ? 0 : 1 }
    binary = pf1.join('')
    puts "  .byte #{binary.to_i(2)}"
  end
  puts ""

  puts "; end of table"
end

rescue => error
  STDERR.puts error.message
  exit 1
end
